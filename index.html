<!DOCTYPE html>
<html>
<head>
  <title>Crime report</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- CSS -->
  <link href='http://fonts.googleapis.com/css?family=Roboto:400,300&subset=latin,cyrillic-ext' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="css/style3.css" />
  <link rel="stylesheet" href="css/leaflet.css" />
  <link href="bootstrap/bootstrap.min.css" rel="stylesheet">
  <!-- JS -->
  <script src="js/leaflet.js"></script>
  <script type="text/javascript" src="js/jquery.min.js"></script>
  <script src="bootstrap/bootstrap.min.js"></script>
  <script src="js/handlebars-v1.3.0.js"></script>
  <script src="js/moment.js"></script>
</head>
<body>

<script type="text/javascript">
  function se () {
    for (var i = 0; i < myMarkers.length; i++) {
        map.removeLayer(myMarkers[i])
    }
    $.get('se.php', {
        searchq: $('#searchbox').val()
    }, function (data) {
        jsonArr = JSON.parse(data);
        $('#feedForm').html('');
        for (_i = jsonArr.length-1, _len = -1; _i > _len; --_i) {
            i = jsonArr[_i];
            console.log(i);
            temp = i['time'].split(':');
            i['time'] = temp[0]+':'+temp[1];
            i['date'] = moment(i['date'], "YYYY-MM-DD").fromNow(); 
            var temp = i['description'];
            temp = temp.split(' ');
            i['category'] = convert_category(i['category']);
            if (temp.length >= 3) {
                var popup_message = '<b>' + i['category'] + '</b><br />' + temp[0] + ' ' + temp[1] + ' ' + temp[2] + '<br />' + '<a onclick=comma("' + i['crime_id'] + '")>\u0427\u0438\u0442\u0430\u0442\u044c \u0434\u0430\u043b\u044c\u0448\u0435 \u2192</a>'
            } else {
                var popup_message = '<b>' + i['category'] + '</b><br />' + temp[0] + '<br />' + '<a onclick=comma("' + i['crime_id'] + '")>\u0427\u0438\u0442\u0430\u0442\u044c \u0434\u0430\u043b\u044c\u0448\u0435 \u2192</a>'
            }
            marker = L.marker([
                i['latitude'],
                i['longitude']
            ]).addTo(map).bindPopup(popup_message);
            myMarkers.push(marker)
            $('#feedForm').append(news(i));
        }
        $('.newsItem').click(function(a) {
        comma(a.toElement.id)});            
    });
}
</script>
  <div id="header">
    <div class="headerImage"> 
      <a href="http://212.112.98.181:22080/~ilia/kraken/"> <img src="images/city4.png" width="110px" height="auto"></a>
    </div>
    <div class="headerText">CrimeReport Bishkek</div>
    <!-- AddThis Follow BEGIN -->
    <div class="addthis_toolbox addthis_default_style">
      <span style="float: left; font-size: 10pt;">Мы в соц. сетях:&nbsp;</span>
      <a class="addthis_button_facebook_follow" addthis:userid="CR"></a>
      <a class="addthis_button_twitter_follow" addthis:userid="CR"></a>
      <a class="addthis_button_google_follow" addthis:userid="CR"></a>
      <a class="addthis_button_instagram_follow" addthis:userid="CR"></a>
    </div>
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-535521f8200c1494"></script>
    <!-- AddThis Follow END -->
  </div>

  <input type="hidden" id="longitude" value="">
  <input type="hidden" id="latitude" value="">

  <div id="feed">
    <div id="submitForm">
      <button type="button" class="submitButton" id="submitButton">Сообщить</button>
    </div>
    <div id="feedFormSettings" style="vertical-align: middle;">
        показывать
        <select id="category">
         <option value="0">все</option>
        <option value="1">кражи</option>
        <option value="2">убийства</option>
        <option value="3">вымогательства</option>
        <option value="4">автоугоны</option>
        <option value="5">изнасилования</option>
        </select>
          <br>
      <div class="settings_container" style="float: left; border-bottom: 3px solid; border-color: #696969;">Последние</div>
      <div class="settings_container" style="float: right;">Добавленные</div>
      
    </div>
    <div id="feedForm">
      <!-- news go here -->
    </div>
      <div id="searchWrapper">
      <form id="searchform" method="post" onsubmit="return false;"><input autocomplete="off" id="searchbox" name="searchq" onkeyup="se()" type="textbox">
      </form>
    </div>
  </div>

  <div id="map"></div>
  <div id="com_helper"></div>

  <script src="js/kraken_map.js"></script>
  <script>

  // Get references to the objects you need (<select> and <span>)
  var category = document.getElementById('category');

  // When the list value changes, set the innerHTML of the <span>
  category.onchange = function() {
    if (this.value != 0) {
      var crime_url = "Controller/Crime_controller?category=" + this.value;
      var crime = JSON.parse(httpGet(crime_url));
      $('#feedForm').html('');
      for (var i = 0; i < myMarkers.length; i++) {
        map.removeLayer(myMarkers[i])
      }
      for (_i = crime.length - 1, _len = -1; _i > _len; --_i) {
              i = crime[_i];
              temp = i['time'].split(':');
              i['time'] = temp[0] + ':' + temp[1];
              i['date'] = moment(i['date'], "YYYY-MM-DD").fromNow();
              var temp = i['description'];
              temp = temp.split(' ');
              i['category'] = convert_category(i['category']);
              if (temp.length >= 3) {
                  var popup_message = '<b>' + i['category'] + '</b><br />' + temp[0] + ' ' + temp[1] + ' ' + temp[2] + '<br />' + '<a onclick=comma("' + i['crime_id'] + '")>\u0427\u0438\u0442\u0430\u0442\u044c \u0434\u0430\u043b\u044c\u0448\u0435 \u2192</a>'
              } else {
                  var popup_message = '<b>' + i['category'] + '</b><br />' + temp[0] + '<br />' + '<a onclick=comma("' + i['crime_id'] + '")>\u0427\u0438\u0442\u0430\u0442\u044c \u0434\u0430\u043b\u044c\u0448\u0435 \u2192</a>'
              }
              marker = L.marker([
                  i['latitude'],
                  i['longitude']
              ]).addTo(map).bindPopup(popup_message);
              myMarkers.push(marker)
              $('#feedForm').append(news(i));
          }
    } else {
      update_news();
    }
  };

  </script>
</body>
</html>